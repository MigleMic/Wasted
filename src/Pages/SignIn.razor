@page "/signIn"

@using Wasted.Data

@using Microsoft.AspNetCore.Components.Authorization

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RegistrationService RegistrationService
@inject NavigationManager NavigationManager

@namespace Wasted
<style>
    @@import "css/Utils.css"
</style>

<div class = "flex">
    <div id="one">
        <h1 class="tac">Sign in</h1>
        <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>
        <form method="post" action="submitscrip.php" target="dummyframe">
        <div> 
            <input class="form-control tac regField" type="email" placeholder="Email" @bind="@SignInEmailBox"/>
            <input class="form-control tac regField" type="password" placeholder="Password" @bind="@SignInPasswordBox"/>
        </div>
        <div>
            <input class="buttonSub" type="submit" @onclick="SignInSubmitPressed"> </input>
        </div>
        </form>
    </div>
    <div id = "vertically-aligned-block"class="flex float">
        @if(ErrorMessages.Any())
        {
            <ul  class="list-style-type: none">
            @foreach(string message in ErrorMessages)
            {
                    @message
                    <br>
            }
            </ul>
        }
    </div>
</div>
@code
{
    static List<User> users = new List<User>();
    static string SignInEmailBox ; 
    static string SignInPasswordBox ;
    public bool signInSuccess = false;
    public static List<string> ErrorMessages = new List<string>();

    public void SignInSubmitPressed()
        {
            ErrorMessages.Clear();
            users = RegistrationService.CreateUserList(users);
            signInSuccess = RegistrationService.CheckSignIn(SignInEmailBox, SignInPasswordBox, users);
            if(signInSuccess)
            {
                ((CustomAuthStateProvider)AuthenticationStateProvider).markUserAsAuthenticated(SignInEmailBox);
                NavigationManager.NavigateTo("/");
                SignInEmailBox = "";
                SignInPasswordBox = "";
            }
            else
            {
                ErrorMessages.Add("Sign in failed");
                ErrorMessages.Add("Please, make sure you enter correct email and password");
                SignInEmailBox = "";
                SignInPasswordBox = "";
            }
        }
}